services:
  native-model:
    image: lmsysorg/sglang:${SGLANG_TAG:-latest-runtime}
    container_name: native-model
    volumes:
      - hf_cache:/root/.cache/huggingface
      - fi_cache:/root/.cache/flashinfer
      - tt_cache:/root/.triton
    restart: always
    privileged: false
    entrypoint: python3 -m sglang.launch_server
    command: >
      --model-path Qwen/Qwen3-0.6B
      --host 0.0.0.0
      --port 30000
      --attention-backend flashinfer
      --dtype bfloat16
      --kv-cache-dtype fp8_e4m3
      --mem-fraction-static 0.2
      --context-length 2048
      --max-total-tokens 2048
      --max-prefill-tokens 512
      --max-running-requests 1
      --cuda-graph-max-bs 1
      --tp 1
      --trust-remote-code
      --enable-metrics
    ulimits:
      memlock: -1
      stack: 67108864
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - sglang-network
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=29000"
      - "prometheus.io/path=/metrics"

  eagle3-model:
    image: lmsysorg/sglang:${SGLANG_TAG:-latest-runtime}
    container_name: eagle3-model
    volumes:
      - hf_cache:/root/.cache/huggingface
      - fi_cache:/root/.cache/flashinfer
      - tt_cache:/root/.triton
      - eagle_cache:/root/.cache/eagle
    restart: always
    privileged: false
    entrypoint: python3 -m sglang.launch_server
    command: >
      --model-path Qwen/Qwen3-0.6B
      --speculative-algorithm EAGLE3
      --speculative-draft-model-path /root/.cache/eagle/qwen3-0.6b-eagle3-sharegpt/epoch_0_step_2048
      --speculative-num-steps 3
      --speculative-eagle-topk 1
      --speculative-num-draft-tokens 4
      --host 0.0.0.0
      --port 30000
      --attention-backend flashinfer
      --dtype bfloat16
      --kv-cache-dtype fp8_e4m3
      --mem-fraction-static 0.18
      --context-length 2048
      --max-total-tokens 2048
      --max-prefill-tokens 512
      --max-running-requests 1
      --cuda-graph-max-bs 1
      --tp 1
      --trust-remote-code
      --enable-metrics
    ulimits:
      memlock: -1
      stack: 67108864
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - sglang-network
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=29000"
      - "prometheus.io/path=/metrics"

  sglang-router:
    image: lmsysorg/sglang:${SGLANG_TAG:-latest-runtime}
    container_name: router
    restart: always
    ports:
      - 30000:30000      # Router API port
      - 29100:29000      # Router Prometheus metrics port
    entrypoint: python3 -m sglang_router.launch_router
    command: >
      --enable-igw
      --host 0.0.0.0
      --port 30000
      --policy cache_aware
      --prometheus-host 0.0.0.0
      --prometheus-port 29000
      --log-level info
    depends_on:
      native-model:
        condition: service_healthy
      eagle3-model:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
    networks:
      - sglang-network
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=29000"
      - "prometheus.io/path=/metrics"

  worker-register:
    image: curlimages/curl:latest
    container_name: sglang-worker-register
    depends_on:
      sglang-router:
        condition: service_healthy
    entrypoint: >
      sh -c "
        sleep 30
        curl -X POST http://sglang-router:30000/workers \\
          -H 'Content-Type: application/json' \\
          -d '{\"url\":\"http://native-model:30000\",\"model_id\":\"qwen3-0.6b\"}'

        curl -X POST http://sglang-router:30000/workers \\
          -H 'Content-Type: application/json' \\
          -d '{\"url\":\"http://eagle3-model:30000\",\"model_id\":\"qwen3-0.6b-eagle\"}'

        echo 'Workers registered successfully'
      "
    network_mode: service:sglang-router

volumes:
  hf_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HOME}/.cache/huggingface
  fi_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: volume/flashinfer
  tt_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: volume/triton
  eagle_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: speculative-decode/cache/eagle

networks:
  sglang-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16