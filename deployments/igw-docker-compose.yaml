services:
  # SGLang Services with Prometheus metrics enabled
  sglang-chat:
    image: lmsysorg/sglang:${SGLANG_TAG:-latest-runtime}
    container_name: sglang-chat
    volumes:
      - hf_cache:/root/.cache/huggingface
      - fi_cache:/root/.cache/flashinfer
      - tt_cache:/root/.triton
    restart: always
    privileged: false
    entrypoint: python3 -m sglang.launch_server
    command: >
      --model-path google/gemma-3-270m-it-qat-q4_0-unquantized
      --host 0.0.0.0
      --port 30000
      --attention-backend flashinfer
      --dtype bfloat16
      --mem-fraction-static 0.1
      --max-total-tokens 2048
      --max-prefill-tokens 512
      --chunked-prefill-size 512
      --enable-metrics
    ulimits:
      memlock: -1
      stack: 67108864
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - sglang-network
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=29000"
      - "prometheus.io/path=/metrics"

  sglang-embedding:
    image: lmsysorg/sglang:${SGLANG_TAG:-latest-runtime}
    container_name: sglang-embedding
    volumes:
      - hf_cache:/root/.cache/huggingface
      - fi_cache:/root/.cache/flashinfer
      - tt_cache:/root/.triton
    restart: always
    privileged: false
    entrypoint: python3 -m sglang.launch_server
    command: >
      --model-path Qwen/Qwen3-Embedding-0.6B
      --is-embedding
      --json-model-override-args '{"matryoshka_dimensions": [128, 256, 512, 1024]}'
      --host 0.0.0.0
      --port 30000
      --attention-backend flashinfer
      --dtype bfloat16
      --mem-fraction-static 0.2
      --kv-cache-dtype fp8_e4m3
      --chunked-prefill-size 8192
      --log-level warning
      --enable-metrics
    ulimits:
      memlock: -1
      stack: 67108864
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - sglang-network
    labels:
    - "prometheus.io/scrape=true"
    - "prometheus.io/port=29000"
    - "prometheus.io/path=/metrics" 

  # SGLang Router with monitoring
  sglang-router:
    image: lmsysorg/sglang:${SGLANG_TAG:-latest-runtime}
    container_name: sglang-router
    restart: always
    ports:
      - 30000:30000      # Router API port
      - 29000:29000      # Router Prometheus metrics port
    entrypoint: python3 -m sglang_router.launch_router
    command: >
      --enable-igw
      --host 0.0.0.0
      --port 30000
      --policy cache_aware
      --prometheus-host 0.0.0.0
      --prometheus-port 29000
      --log-level info
    networks:
      - sglang-network
    depends_on:
      sglang-chat:
        condition: service_healthy
      sglang-embedding:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=29000"
      - "prometheus.io/path=/metrics"

  worker-register:
    image: curlimages/curl:latest
    container_name: sglang-worker-register
    depends_on:
      sglang-router:
        condition: service_healthy
    entrypoint: >
      sh -c "
        sleep 30
        curl -X POST http://sglang-router:30000/workers \\
          -H 'Content-Type: application/json' \\
          -d '{\"url\":\"http://sglang-chat:30000\",\"model_id\":\"gemma-3-270m-it\",\"priority\":10,\"labels\":{\"tier\":\"gold\"}}'
          
        curl -X POST http://sglang-router:30000/workers \\
          -H 'Content-Type: application/json' \\
          -d '{\"url\":\"http://sglang-embedding:30000\",\"model_id\":\"qwen3-embedding-0.6b\",\"priority\":10,\"labels\":{\"tier\":\"gold\"}}'
          
        echo 'Workers registered successfully'
      "
    network_mode: service:sglang-router

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./deployments/prometheus/prometheus.yaml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - sglang-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - 3000:3000
    volumes:
      - ./deployments/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./deployments/grafana/dashboards/config:/etc/grafana/provisioning/dashboards
      - ./deployments/grafana/dashboards/json:/var/lib/grafana/dashboards
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_AUTH_BASIC_ENABLED=false
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/sglang-dashboard.json
    depends_on:
      - prometheus
    networks:
      - sglang-network

volumes:
  hf_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HOME}/.cache/huggingface
  fi_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: volume/flashinfer
  tt_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: volume/triton

networks:
  sglang-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16